trigger:
  branches:
    include:
    - master
  paths:
    include:
    - build/infrastructure/azure-kubernetes-service/*

pr:
  branches:
    include:
    - master
    - feat/*
    - fix/*
    - chore/*
    - refactor/*
  paths:
    include:
    - build/infrastructure/azure-kubernetes-service/*

stages:
  - stage: Deploy
    displayName: 'Deploy'
    jobs:
      - job: Deploy
        pool:
          vmImage: 'ubuntu-latest'

        variables:
          resourceGroupName: 'kubernetes-playground-test-rg'
          location: 'South Africa North'

        steps:
        - task: AzureResourceManagerTemplateDeployment@3
          inputs:
            deploymentScope: 'Resource Group'
            azureResourceManagerConnection: 'MyARMConnection'
            subscriptionId: '$(subscriptionId)'
            action: 'Create Or Update Resource Group'
            resourceGroupName: '$(resourceGroupName)'
            location: '$(location)'
            templateLocation: 'Linked artifact'
            csmFile: 'build/infrastructure/azure-kubernetes-service/azuredeploy.json'
            csmParametersFile: 'build/infrastructure/azure-kubernetes-service/azuredeploy.parameters.json'
            deploymentMode: 'Incremental'

  - stage: PostDeploy
    displayName: 'Post Deploy'
    jobs:
      - job: 'PostDeploySetup'
        pool:
          vmImage: 'ubuntu-latest'

        steps:
        - task: Kubernetes@1
          inputs:
            connectionType: 'Azure Resource Manager'
            azureSubscriptionEndpoint: 'MyARMConnection'
            azureResourceGroup: 'kubernetes-playground-test-rg'
            kubernetesCluster: 'aks-cluster'
            useClusterAdmin: true
            command: 'get'
            arguments: 'ns'