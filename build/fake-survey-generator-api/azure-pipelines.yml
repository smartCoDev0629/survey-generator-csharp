trigger:
  branches:
    include:
    - master
    - feat/*
    - fix/*
    - chore/*
  paths:
    include:
    - src/server/FakeSurveyGenerator.API/*
    - src/server/FakeSurveyGenerator.API.Tests.Integration/*
    - src/server/FakeSurveyGenerator.Domain/*
    - src/server/FakeSurveyGenerator.Domain.Tests/*
    - src/server/FakeSurveyGenerator.EF.Design/*
    - src/server/FakeSurveyGenerator.Infrastructure/*
    - charts/fake-survey-generator-api/*
    - build/fake-survey-generator-api/*

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'
  dockerId: marcelmichau
  imageName: fakesurveygeneratorapi
  versionTag: $(build.buildNumber)

steps:
- task: DotNetCoreInstaller@0
  displayName: 'Install .net core 3.0 (preview)'
  inputs:
    version: '3.0.100-preview9-014004'

- script: dotnet build FakeSurveyGenerator.sln --configuration $(buildConfiguration)
  displayName: 'Build Solution'

- script: dotnet test src/server/FakeSurveyGenerator.Domain.Tests/FakeSurveyGenerator.Domain.Tests.csproj --logger trx
  displayName: 'Run Unit Tests'

- script: dotnet test src/server/FakeSurveyGenerator.API.Tests.Integration/FakeSurveyGenerator.API.Tests.Integration.csproj --logger trx
  displayName: 'Run Integration Tests'

- task: PublishTestResults@2
  condition: succeededOrFailed()
  inputs:
    testRunner: VSTest
    testResultsFiles: '**/*.trx'
  displayName: 'Publish Test Results'

- script: |
    dotnet tool install --global dotnet-ef --version 3.0.0-*
  displayName: 'Install EF Core Global Tool'

- script: |
    dotnet ef migrations script -o DbMigrationScript.sql -i
  workingDirectory: src/server/FakeSurveyGenerator.EF.Design
  displayName: 'Create Database Migration Script'

- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: src/server/FakeSurveyGenerator.EF.Design/DbMigrationScript.sql
    artifactName: DbMigrationScript
  displayName: 'Publish Database Migration Script'

- script: |
    docker build -t $(dockerId)/$(imageName):$(versionTag) -t $(dockerId)/$(imageName):latest -f src/server/FakeSurveyGenerator.API/Dockerfile .
  displayName: 'Build Docker Image'

- script: |
    echo "$DOCKER_PASSWORD" | docker login -u $(dockerId) --password-stdin
    docker push $(dockerId)/$(imageName)
  env:
    DOCKER_PASSWORD: $(dockerPassword)
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
  displayName: 'Push Image to Docker Hub'

- task: HelmInstaller@1
  inputs:
    helmVersionToInstall: 'latest'
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
  displayName: 'Install Helm'

- task: HelmDeploy@0
  inputs:
    command: 'package'
    arguments: '--version $(versionTag)'
    chartPath: 'charts/fake-survey-generator-api'
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
  displayName: 'Helm Package'

- task: AzureCLI@1
  inputs:
    azureSubscription: 'Visual Studio Enterprise(492e64aa-2506-4b65-8105-b490c3c34a40)'
    scriptLocation: 'inlineScript'
    inlineScript: 'az configure --defaults acr=marcelmichaucrv1'
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
  displayName: 'Set Azure Container Registry Default in Azure CLI'

- task: AzureCLI@1
  inputs:
    azureSubscription: 'Visual Studio Enterprise(492e64aa-2506-4b65-8105-b490c3c34a40)'
    scriptLocation: 'inlineScript'
    inlineScript: 'az acr helm repo add'
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
  displayName: 'Add Azure Container Registry Repo to Azure CLI'

- task: AzureCLI@1
  inputs:
    azureSubscription: 'Visual Studio Enterprise(492e64aa-2506-4b65-8105-b490c3c34a40)'
    scriptLocation: 'inlineScript'
    inlineScript: 'az acr helm push $(Build.ArtifactStagingDirectory)/fake-survey-generator-api-$(versionTag).tgz'
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
  displayName: 'Push Helm Chart to Azure Container Registry'